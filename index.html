<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        h2 {
            color: #ff6b6b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .products-section {
            background: #fff3cd;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 3px solid #ffc107;
        }

        .product-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            flex-wrap: wrap;
            gap: 15px;
        }

        .product-name-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .number-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            transition: all 0.3s;
        }

        .number-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .winner-highlight {
            background: #d4edda !important;
            border-color: #28a745 !important;
        }

        .winner-highlight:hover {
            border-color: #28a745 !important;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3) !important;
        }

        .number-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .number-label {
            font-weight: bold;
            color: #495057;
            font-size: 1.1em;
        }

        .add-product-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .add-product-form input {
            flex: 1;
            min-width: 200px;
        }

        .product-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .customer-tag {
            background: #2196F3;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .customer-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            margin-left: 5px;
        }

        .customer-tag button:hover {
            color: #ffcdd2;
        }

        .summary-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .detailed-summary-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            flex-wrap: wrap;
            gap: 10px;
        }

        .summary-customer-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .summary-total {
            font-size: 1.3em;
            font-weight: bold;
            color: #28a745;
        }

        .summary-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .summary-items-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }

        .summary-items-table td {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .winner-badge {
            background: #28a745;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 12px;
            font-size: 0.9em;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-export {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            font-size: 1.1em;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-export:hover {
            background: #218838;
        }

        .grand-total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-top: 30px;
            font-size: 1.8em;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .export-section {
            text-align: center;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.9em;
            }

            .grand-total {
                font-size: 1.4em;
                padding: 20px;
            }

            .numbers-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                max-width: 95%;
            }

            input[type="text"],
            input[type="number"],
            select {
                font-size: 1.1em;
                padding: 12px;
            }

            .btn {
                padding: 14px 28px;
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á</h1>

        <!-- Customer Management Section -->
        <div class="products-section" style="background: #e7f3ff; border-color: #2196F3;">
            <h2>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
            
            <div class="add-product-form">
                <input type="text" id="newCustomerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" />
                <button class="btn btn-success" onclick="addCustomer()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
            </div>

            <div id="customerList" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;"></div>
        </div>

        <!-- Products Management Section -->
        <div class="products-section">
            <h2>üè∑Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
            
            <div class="add-product-form">
                <input type="text" id="newProductName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" />
                <input type="number" id="newProductPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏Ç (‡∏ö‡∏≤‡∏ó)" min="0" step="0.01" />
                <button class="btn btn-success" onclick="addProduct()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
            </div>

            <div class="product-list" id="productList"></div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
            <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô</h3>
            <div id="detailedSummary"></div>
        </div>

        <div class="grand-total">
            ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="grandTotal">0.00</span> ‡∏ö‡∏≤‡∏ó
        </div>

        <div class="export-section">
            <button class="btn btn-export" onclick="exportToExcel()">
                üìä Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô Excel
            </button>
        </div>
    </div>

    <!-- SheetJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let products = [];
        let customers = [];

        // Load data from localStorage on page load
        window.onload = function() {
            const savedData = localStorage.getItem('shoppingTrackerData');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    products = Array.isArray(parsed.products) ? parsed.products : [];
                    customers = Array.isArray(parsed.customers) ? parsed.customers : [];
                } catch (e) {
                    console.error('Error loading data:', e);
                    products = [];
                    customers = [];
                }
            }
            renderCustomers();
            renderProducts();
            renderSummary();
        };

        function saveData() {
            localStorage.setItem('shoppingTrackerData', JSON.stringify({
                products: products,
                customers: customers
            }));
        }

        // ========== Customer Management ==========
        function addCustomer() {
            const nameInput = document.getElementById('newCustomerName');
            const name = nameInput.value.trim();
            
            if (name === '') {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
                return;
            }

            if (customers.includes(name)) {
                alert('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }

            customers.push(name);
            customers.sort();
            nameInput.value = '';
            renderCustomers();
            renderProducts();
            saveData();
        }

        function deleteCustomer(customerName) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ "' + customerName + '" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏à‡∏∞‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏ß‡∏¢)')) {
                customers = customers.filter(c => c !== customerName);
                
                products.forEach(product => {
                    product.numbers.forEach(num => {
                        if (num.buyer === customerName) {
                            num.buyer = '';
                        }
                    });
                });
                
                renderCustomers();
                renderProducts();
                renderSummary();
                saveData();
            }
        }

        function renderCustomers() {
            const container = document.getElementById('customerList');
            
            if (customers.length === 0) {
                container.innerHTML = '<span style="color: #999;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>';
                return;
            }

            container.innerHTML = customers.map(customer => {
                const safeName = customer.replace(/'/g, "\\'");
                return '<span class="customer-tag">üë§ ' + customer + '<button onclick="deleteCustomer(\'' + safeName + '\')">√ó</button></span>';
            }).join('');
        }

        // ========== Product Management ==========
        function addProduct() {
            const nameInput = document.getElementById('newProductName');
            const priceInput = document.getElementById('newProductPrice');
            
            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);
            
            if (name === '') {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
                return;
            }
            
            if (isNaN(price) || price < 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }

            const numbers = [];
            for (let i = 1; i <= 10; i++) {
                numbers.push({
                    number: i,
                    buyer: '',
                    isWinner: false
                });
            }

            products.push({
                id: Date.now(),
                name: name,
                price: price,
                numbers: numbers
            });

            nameInput.value = '';
            priceInput.value = '';
            renderProducts();
            renderSummary();
            saveData();
        }

        function deleteProduct(productId) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                products = products.filter(p => p.id !== productId);
                renderProducts();
                renderSummary();
                saveData();
            }
        }

        function updateBuyer(productId, numberIndex, buyerName) {
            const product = products.find(p => p.id === productId);
            if (product) {
                product.numbers[numberIndex].buyer = buyerName;
                renderSummary();
                saveData();
            }
        }

        function toggleWinner(productId, numberIndex) {
            const product = products.find(p => p.id === productId);
            if (product) {
                product.numbers[numberIndex].isWinner = !product.numbers[numberIndex].isWinner;
                renderProducts();
                renderSummary();
                saveData();
            }
        }

        function renderProducts() {
            const container = document.getElementById('productList');
            
            if (products.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</div>';
                return;
            }

            const customerOptions = customers.length > 0 
                ? customers.map(c => '<option value="' + c + '">' + c + '</option>').join('')
                : '<option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô</option>';

            container.innerHTML = products.map(product => {
                const numbersHtml = product.numbers.map((num, index) => {
                    const winnerClass = num.isWinner ? 'winner-highlight' : '';
                    const selectId = 'select_' + product.id + '_' + index;
                    return '<div class="number-item ' + winnerClass + '">' +
                        '<div class="number-header">' +
                            '<span class="number-label">‡πÄ‡∏•‡∏Ç ' + num.number + '</span>' +
                            '<label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">' +
                                '<input type="checkbox" ' + (num.isWinner ? 'checked' : '') + ' ' +
                                'onchange="toggleWinner(' + product.id + ', ' + index + ')" ' +
                                'style="cursor: pointer;" />' +
                                '<span style="font-size: 0.85em; color: #28a745;">üèÜ</span>' +
                            '</label>' +
                        '</div>' +
                        '<select id="' + selectId + '" onchange="updateBuyer(' + product.id + ', ' + index + ', this.value)">' +
                            '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>' +
                            customerOptions +
                        '</select>' +
                        (num.buyer ? '<div style="margin-top: 8px; color: #667eea; font-weight: bold;">üë§ ' + num.buyer + '</div>' : 
                         '<div style="margin-top: 8px; color: #999; font-size: 0.85em;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>') +
                    '</div>';
                }).join('');

                return '<div class="product-card">' +
                    '<div class="product-header">' +
                        '<div>' +
                            '<span class="product-name-display">' + product.name + '</span>' +
                            '<div style="color: #667eea; font-size: 1.2em; margin-top: 5px;">' +
                                '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏•‡∏Ç‡∏•‡∏∞: ' + product.price.toFixed(2) + ' ‡∏ö‡∏≤‡∏ó' +
                            '</div>' +
                        '</div>' +
                        '<button class="btn btn-danger" onclick="deleteProduct(' + product.id + ')">üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>' +
                    '</div>' +
                    '<div class="numbers-grid">' + numbersHtml + '</div>' +
                '</div>';
            }).join('');

            // Set selected values after rendering
            products.forEach(product => {
                product.numbers.forEach((num, index) => {
                    if (num.buyer) {
                        const selectId = 'select_' + product.id + '_' + index;
                        const selectElement = document.getElementById(selectId);
                        if (selectElement) {
                            selectElement.value = num.buyer;
                        }
                    }
                });
            });
        }

        function calculateCustomerDetails() {
            const customerDetails = {};

            products.forEach(product => {
                product.numbers.forEach(num => {
                    if (num.buyer && num.buyer.trim() !== '') {
                        const customerName = num.buyer.trim();
                        if (!customerDetails[customerName]) {
                            customerDetails[customerName] = {
                                items: [],
                                total: 0,
                                winCount: 0,
                                winAmount: 0
                            };
                        }
                        customerDetails[customerName].items.push({
                            product: product.name,
                            number: num.number,
                            price: product.price,
                            isWinner: num.isWinner
                        });
                        customerDetails[customerName].total += product.price;
                        if (num.isWinner) {
                            customerDetails[customerName].winCount += 1;
                            customerDetails[customerName].winAmount += product.price;
                        }
                    }
                });
            });

            return customerDetails;
        }

        function calculateGrandTotal() {
            let total = 0;
            products.forEach(product => {
                product.numbers.forEach(num => {
                    if (num.buyer) {
                        total += product.price;
                    }
                });
            });
            return total;
        }

        function renderSummary() {
            const customerDetails = calculateCustomerDetails();
            const container = document.getElementById('detailedSummary');
            
            if (Object.keys(customerDetails).length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                document.getElementById('grandTotal').textContent = '0.00';
                return;
            }

            const sortedCustomers = Object.entries(customerDetails).sort((a, b) => a[0].localeCompare(b[0]));

            container.innerHTML = sortedCustomers.map(([name, data]) => {
                const itemsHtml = data.items.map(item => {
                    return '<tr>' +
                        '<td><strong>' + item.product + '</strong></td>' +
                        '<td>‡πÄ‡∏•‡∏Ç ' + item.number + '</td>' +
                        '<td>' + item.price.toFixed(2) + ' ‡∏ö‡∏≤‡∏ó</td>' +
                        '<td>' + (item.isWinner ? '<span class="winner-badge">üèÜ ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</span>' : '-') + '</td>' +
                    '</tr>';
                }).join('');

                return '<div class="detailed-summary-card">' +
                    '<div class="summary-header">' +
                        '<span class="summary-customer-name">üë§ ' + name + '</span>' +
                        '<span class="summary-total">‡∏£‡∏ß‡∏°: ' + data.total.toFixed(2) + ' ‡∏ö‡∏≤‡∏ó</span>' +
                    '</div>' +
                    '<table class="summary-items-table">' +
                        '<thead>' +
                            '<tr>' +
                                '<th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>' +
                                '<th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>' +
                                '<th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>' +
                                '<th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>' +
                            '</tr>' +
                        '</thead>' +
                        '<tbody>' +
                            itemsHtml +
                            '<tr style="background: #f8f9fa; font-weight: bold;">' +
                                '<td colspan="2">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>' +
                                '<td>' + data.total.toFixed(2) + ' ‡∏ö‡∏≤‡∏ó</td>' +
                                '<td>' + (data.winCount > 0 ? 'üèÜ ' + data.winCount + ' ‡πÄ‡∏•‡∏Ç (' + data.winAmount.toFixed(2) + ' ‡∏ö‡∏≤‡∏ó)' : '-') + '</td>' +
                            '</tr>' +
                        '</tbody>' +
                    '</table>' +
                '</div>';
            }).join('');

            document.getElementById('grandTotal').textContent = calculateGrandTotal().toFixed(2);
        }

        // Allow Enter key
        document.getElementById('newCustomerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addCustomer();
            }
        });

        document.getElementById('newProductName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('newProductPrice').focus();
            }
        });

        document.getElementById('newProductPrice').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addProduct();
            }
        });

        // ========== Export to Excel ==========
        function exportToExcel() {
            if (products.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const wb = XLSX.utils.book_new();
            const customerDetails = calculateCustomerDetails();

            // Sheet 1: ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            const summaryData = [
                ['‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'],
                [],
                ['‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏•‡∏Ç', '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)', '‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (‡πÄ‡∏•‡∏Ç)', '‡∏¢‡∏≠‡∏î‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (‡∏ö‡∏≤‡∏ó)']
            ];

            const sortedCustomers = Object.entries(customerDetails).sort((a, b) => a[0].localeCompare(b[0]));
            sortedCustomers.forEach(([name, data]) => {
                summaryData.push([
                    name,
                    data.items.length,
                    data.total,
                    data.winCount,
                    data.winAmount
                ]);
            });

            summaryData.push([]);
            summaryData.push(['‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '', calculateGrandTotal(), '', '']);

            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            ws1['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 18 }, { wch: 20 }, { wch: 22 }];
            XLSX.utils.book_append_sheet(wb, ws1, '‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');

            // Sheet 2: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const detailData = [
                ['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'],
                [],
                ['‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà', '‡∏£‡∏≤‡∏Ñ‡∏≤', '‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•']
            ];

            sortedCustomers.forEach(([name, data]) => {
                data.items.forEach((item, index) => {
                    detailData.push([
                        index === 0 ? name : '',
                        item.product,
                        '‡πÄ‡∏•‡∏Ç ' + item.number,
                        item.price,
                        item.isWinner ? 'üèÜ ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•' : ''
                    ]);
                });
                detailData.push([]);
            });

            const ws2 = XLSX.utils.aoa_to_sheet(detailData);
            ws2['!cols'] = [{ wch: 25 }, { wch: 25 }, { wch: 12 }, { wch: 12 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws2, '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');

            // Sheet 3+: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            sortedCustomers.forEach(([name, data]) => {
                const customerData = [
                    ['‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ' + name],
                    [],
                    ['‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà', '‡∏£‡∏≤‡∏Ñ‡∏≤', '‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•']
                ];

                data.items.forEach(item => {
                    customerData.push([
                        item.product,
                        '‡πÄ‡∏•‡∏Ç ' + item.number,
                        item.price,
                        item.isWinner ? 'üèÜ ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•' : ''
                    ]);
                });

                customerData.push([]);
                customerData.push(['‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '', data.total, '']);
                if (data.winCount > 0) {
                    customerData.push(['‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏£‡∏ß‡∏°', data.winCount + ' ‡πÄ‡∏•‡∏Ç', data.winAmount, '']);
                }

                const wsCustomer = XLSX.utils.aoa_to_sheet(customerData);
                wsCustomer['!cols'] = [{ wch: 25 }, { wch: 12 }, { wch: 15 }, { wch: 15 }];

                const sheetName = name.substring(0, 31).replace(/[:\\/?*\[\]]/g, '');
                XLSX.utils.book_append_sheet(wb, wsCustomer, sheetName);
            });

            // Sheet: ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            products.forEach(product => {
                const productData = [
                    ['‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ' + product.name],
                    ['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏Ç: ' + product.price.toFixed(2) + ' ‡∏ö‡∏≤‡∏ó'],
                    [],
                    ['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà', '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', '‡∏£‡∏≤‡∏Ñ‡∏≤', '‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•']
                ];

                product.numbers.forEach(num => {
                    if (num.buyer) {
                        productData.push([
                            '‡πÄ‡∏•‡∏Ç ' + num.number,
                            num.buyer,
                            product.price,
                            num.isWinner ? 'üèÜ ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•' : ''
                        ]);
                    }
                });

                const wsProduct = XLSX.utils.aoa_to_sheet(productData);
                wsProduct['!cols'] = [{ wch: 12 }, { wch: 20 }, { wch: 12 }, { wch: 15 }];

                const sheetName = ('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤_' + product.name).substring(0, 31).replace(/[:\\/?*\[\]]/g, '');
                XLSX.utils.book_append_sheet(wb, wsProduct, sheetName);
            });

            const now = new Date();
            const dateStr = now.getFullYear() + '-' + 
                           String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(now.getDate()).padStart(2, '0');
            const filename = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á_' + dateStr + '.xlsx';

            XLSX.writeFile(wb, filename);
        }
    </script>
</body>
</html>