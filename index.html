<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { text-align: center; color: #667eea; margin-bottom: 30px; font-size: 2.5em; }
        h2 { color: #ff6b6b; margin-bottom: 20px; }
        h3 { color: #667eea; margin-bottom: 15px; }
        .products-section {
            background: #fff3cd;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 3px solid #ffc107;
        }
        .product-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            flex-wrap: wrap;
            gap: 15px;
        }
        .product-name-display { font-size: 1.5em; font-weight: bold; color: #667eea; }
        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .number-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            transition: all 0.3s;
        }
        .number-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        .winner-highlight {
            background: #d4edda !important;
            border-color: #28a745 !important;
        }
        .number-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .number-label { font-weight: bold; color: #495057; font-size: 1.1em; }
        .add-product-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .add-product-form input { flex: 1; min-width: 200px; }
        .customer-tag {
            background: #2196F3;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
        }
        .customer-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            margin-left: 5px;
        }
        .summary-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }
        .detailed-summary-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            flex-wrap: wrap;
            gap: 10px;
        }
        .summary-customer-name { font-size: 1.5em; font-weight: bold; color: #667eea; }
        .summary-total { font-size: 1.3em; font-weight: bold; color: #28a745; }
        .summary-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .summary-items-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }
        .summary-items-table td {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        .winner-badge {
            background: #28a745;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
            -webkit-appearance: none;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-success { background: #28a745; color: white; }
        .btn-success:active { background: #218838; }
        .btn-danger { background: #dc3545; color: white; padding: 10px 14px; }
        .btn-danger:active { background: #c82333; }
        .btn-export {
            background: #28a745;
            color: white;
            padding: 16px 32px;
            font-size: 1.1em;
        }
        .grand-total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-top: 30px;
            font-size: 1.8em;
            font-weight: bold;
        }
        .export-section { text-align: center; margin-top: 20px; }
        @media (max-width: 768px) {
            .container { padding: 15px; }
            h1 { font-size: 1.8em; }
            .numbers-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á</h1>

        <div class="products-section" style="background: #e7f3ff; border-color: #2196F3;">
            <h2>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
            <div class="add-product-form">
                <input type="text" id="newCustomerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" />
                <button class="btn btn-success" onclick="addCustomer()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
            </div>
            <div id="customerList"></div>
        </div>

        <div class="products-section">
            <h2>üè∑Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
            <div class="add-product-form">
                <input type="text" id="newProductName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" />
                <input type="number" id="newProductPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏Ç (‡∏ö‡∏≤‡∏ó)" min="0" step="0.01" />
                <button class="btn btn-success" onclick="addProduct()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            <div class="product-list" id="productList"></div>
        </div>

        <div class="summary-section">
            <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô</h3>
            <div id="detailedSummary"></div>
        </div>

        <div class="grand-total">
            ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="grandTotal">0.00</span> ‡∏ö‡∏≤‡∏ó
        </div>

        <div class="export-section">
            <button class="btn btn-export" onclick="exportToExcel()">üìä Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô Excel</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
var products = [];
var customers = [];

window.onload = function() {
    var savedData = localStorage.getItem('shoppingTrackerData');
    if (savedData) {
        try {
            var parsed = JSON.parse(savedData);
            products = Array.isArray(parsed.products) ? parsed.products : [];
            customers = Array.isArray(parsed.customers) ? parsed.customers : [];
        } catch (e) {
            console.error('Error:', e);
            products = [];
            customers = [];
        }
    }
    renderCustomers();
    renderProducts();
    renderSummary();
};

function saveData() {
    localStorage.setItem('shoppingTrackerData', JSON.stringify({
        products: products,
        customers: customers
    }));
}

function addCustomer() {
    var nameInput = document.getElementById('newCustomerName');
    var name = nameInput.value.trim();
    
    if (!name) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
        return;
    }
    if (customers.indexOf(name) !== -1) {
        alert('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
        return;
    }
    customers.push(name);
    customers.sort();
    nameInput.value = '';
    renderCustomers();
    renderProducts();
    saveData();
}

function deleteCustomer(customerName) {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ "' + customerName + '" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
    customers = customers.filter(function(c) { return c !== customerName; });
    products.forEach(function(product) {
        product.numbers.forEach(function(num) {
            if (num.buyer === customerName) num.buyer = '';
        });
    });
    renderCustomers();
    renderProducts();
    renderSummary();
    saveData();
}

function renderCustomers() {
    var container = document.getElementById('customerList');
    if (!customers.length) {
        container.innerHTML = '<span style="color: #999;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>';
        return;
    }
    container.innerHTML = customers.map(function(c) {
        return '<span class="customer-tag">üë§ ' + c + '<button onclick="deleteCustomer(\'' + c.replace(/'/g, "\\'") + '\')">√ó</button></span>';
    }).join('');
}

function addProduct() {
    var nameInput = document.getElementById('newProductName');
    var priceInput = document.getElementById('newProductPrice');
    var name = nameInput.value.trim();
    var price = parseFloat(priceInput.value);
    
    if (!name) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
        return;
    }
    if (isNaN(price) || price < 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
    }
    
    var numbers = [];
    for (var i = 1; i <= 10; i++) {
        numbers.push({ number: i, buyer: '', isWinner: false });
    }
    
    products.push({
        id: Date.now(),
        name: name,
        price: price,
        numbers: numbers
    });
    
    nameInput.value = '';
    priceInput.value = '';
    renderProducts();
    renderSummary();
    saveData();
}

function deleteProduct(productId) {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
    products = products.filter(function(p) { return p.id !== productId; });
    renderProducts();
    renderSummary();
    saveData();
}

function updateBuyer(productId, numberIndex, buyerName) {
    var product = products.find(function(p) { return p.id === productId; });
    if (product) {
        product.numbers[numberIndex].buyer = buyerName;
        renderSummary();
        saveData();
    }
}

function toggleWinner(productId, numberIndex) {
    var product = products.find(function(p) { return p.id === productId; });
    if (product) {
        product.numbers[numberIndex].isWinner = !product.numbers[numberIndex].isWinner;
        renderProducts();
        renderSummary();
        saveData();
    }
}

function renderProducts() {
    var container = document.getElementById('productList');
    if (!products.length) {
        container.innerHTML = '<div style="text-align:center;color:#999;padding:20px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';
        return;
    }
    
    var customerOptions = customers.length > 0 
        ? customers.map(function(c) { return '<option value="' + c + '">' + c + '</option>'; }).join('')
        : '<option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>';
    
    var html = '';
    products.forEach(function(product) {
        html += '<div class="product-card">';
        html += '<div class="product-header">';
        html += '<div><span class="product-name-display">' + product.name + '</span>';
        html += '<div style="color:#667eea;font-size:1.2em;margin-top:5px">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏•‡∏Ç‡∏•‡∏∞: ' + product.price.toFixed(2) + ' ‡∏ö‡∏≤‡∏ó</div></div>';
        html += '<button class="btn btn-danger" onclick="deleteProduct(' + product.id + ')">üóëÔ∏è ‡∏•‡∏ö</button>';
        html += '</div><div class="numbers-grid">';
        
        product.numbers.forEach(function(num, idx) {
            var winClass = num.isWinner ? ' winner-highlight' : '';
            html += '<div class="number-item' + winClass + '">';
            html += '<div class="number-header">';
            html += '<span class="number-label">‡πÄ‡∏•‡∏Ç ' + num.number + '</span>';
            html += '<label style="display:flex;align-items:center;gap:5px;cursor:pointer">';
            html += '<input type="checkbox"' + (num.isWinner ? ' checked' : '') + ' onchange="toggleWinner(' + product.id + ',' + idx + ')" style="cursor:pointer"/>';
            html += '<span style="font-size:0.85em;color:#28a745">üèÜ</span></label></div>';
            html += '<select id="sel_' + product.id + '_' + idx + '" onchange="updateBuyer(' + product.id + ',' + idx + ',this.value)" style="margin-bottom:8px">';
            html += '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>' + customerOptions + '</select>';
            html += num.buyer ? '<div style="margin-top:8px;color:#667eea;font-weight:bold">üë§ ' + num.buyer + '</div>' : '<div style="margin-top:8px;color:#999;font-size:0.85em">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>';
            html += '</div>';
        });
        
        html += '</div></div>';
    });
    
    container.innerHTML = html;
    
    setTimeout(function() {
        products.forEach(function(product) {
            product.numbers.forEach(function(num, idx) {
                if (num.buyer) {
                    var sel = document.getElementById('sel_' + product.id + '_' + idx);
                    if (sel) sel.value = num.buyer;
                }
            });
        });
    }, 100);
}

function calculateCustomerDetails() {
    var details = {};
    products.forEach(function(product) {
        product.numbers.forEach(function(num) {
            if (num.buyer && num.buyer.trim()) {
                var name = num.buyer.trim();
                if (!details[name]) {
                    details[name] = { items: [], total: 0, winCount: 0, winAmount: 0 };
                }
                details[name].items.push({
                    product: product.name,
                    number: num.number,
                    price: product.price,
                    isWinner: num.isWinner
                });
                details[name].total += product.price;
                if (num.isWinner) {
                    details[name].winCount++;
                    details[name].winAmount += product.price;
                }
            }
        });
    });
    return details;
}

function calculateGrandTotal() {
    var total = 0;
    products.forEach(function(product) {
        product.numbers.forEach(function(num) {
            if (num.buyer) total += product.price;
        });
    });
    return total;
}

function renderSummary() {
    var details = calculateCustomerDetails();
    var container = document.getElementById('detailedSummary');
    
    if (!Object.keys(details).length) {
        container.innerHTML = '<div style="text-align:center;color:#999;padding:40px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
        document.getElementById('grandTotal').textContent = '0.00';
        return;
    }
    
    var sorted = Object.keys(details).sort().map(function(k) { return [k, details[k]]; });
    var html = '';
    
    sorted.forEach(function(pair) {
        var name = pair[0];
        var data = pair[1];
        html += '<div class="detailed-summary-card">';
        html += '<div class="summary-header">';
        html += '<span class="summary-customer-name">üë§ ' + name + '</span>';
        html += '<span class="summary-total">‡∏£‡∏ß‡∏°: ' + data.total.toFixed(2) + ' ‡∏ö‡∏≤‡∏ó</span></div>';
        html += '<table class="summary-items-table"><thead><tr>';
        html += '<th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody>';
        
        data.items.forEach(function(item) {
            html += '<tr><td><strong>' + item.product + '</strong></td>';
            html += '<td>‡πÄ‡∏•‡∏Ç ' + item.number + '</td>';
            html += '<td>' + item.price.toFixed(2) + ' ‡∏ö‡∏≤‡∏ó</td>';
            html += '<td>' + (item.isWinner ? '<span class="winner-badge">üèÜ ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</span>' : '-') + '</td></tr>';
        });
        
        html += '<tr style="background:#f8f9fa;font-weight:bold">';
        html += '<td colspan="2">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>';
        html += '<td>' + data.total.toFixed(2) + ' ‡∏ö‡∏≤‡∏ó</td>';
        html += '<td>' + (data.winCount > 0 ? 'üèÜ ' + data.winCount + ' ‡πÄ‡∏•‡∏Ç (' + data.winAmount.toFixed(2) + ' ‡∏ö‡∏≤‡∏ó)' : '-') + '</td>';
        html += '</tr></tbody></table></div>';
    });
    
    container.innerHTML = html;
    document.getElementById('grandTotal').textContent = calculateGrandTotal().toFixed(2);
}

document.getElementById('newCustomerName').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') addCustomer();
});
document.getElementById('newProductName').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') document.getElementById('newProductPrice').focus();
});
document.getElementById('newProductPrice').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') addProduct();
});

function exportToExcel() {
    if (!products.length) {
        alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        return;
    }
    var wb = XLSX.utils.book_new();
    var details = calculateCustomerDetails();
    var summaryData = [['‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'], [], ['‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏•‡∏Ç', '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°', '‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•', '‡∏¢‡∏≠‡∏î‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•']];
    var sorted = Object.keys(details).sort().map(function(k) { return [k, details[k]]; });
    sorted.forEach(function(p) {
        summaryData.push([p[0], p[1].items.length, p[1].total, p[1].winCount, p[1].winAmount]);
    });
    summaryData.push([]);
    summaryData.push(['‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°', '', calculateGrandTotal(), '', '']);
    var ws1 = XLSX.utils.aoa_to_sheet(summaryData);
    ws1['!cols'] = [{wch:25},{wch:15},{wch:18},{wch:20},{wch:22}];
    XLSX.utils.book_append_sheet(wb, ws1, '‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');
    
    var now = new Date();
    var dateStr = now.getFullYear() + '-' + ('0' + (now.getMonth() + 1)).slice(-2) + '-' + ('0' + now.getDate()).slice(-2);
    XLSX.writeFile(wb, '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô_' + dateStr + '.xlsx');
}
</script></body></html>